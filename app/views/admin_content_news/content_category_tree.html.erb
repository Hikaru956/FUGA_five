<!-- === Masthead === -->

<ul class="breadcrumb">
  <li><%= link_to "トップ", :action=>"content_root" %>&nbsp;<span class="divider">/</span></li>


  <% ancs = @current_category.ancestors.reverse %>
  <% ancs.each do |cat| %>
    <% next if cat.category_type < 100 %>
    <li><%= link_to cat.category_label, :action=>"content_category_tree", :id=>cat %>&nbsp;<span class="divider">/</span></li>
  <% end %>
  <li class="active"><%= @current_category.category_label%></li>
</ul>

<div>
	<span class='float-right'>
		<a class="btn btn-small btn-secondary" href="<%=url_for(:action=>"content_category", :id=>@parent_category)%>">
			<%= backward_icon('戻る') %>&nbsp;戻る</a>
		<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNew">
			<%= new_icon('登録') %>&nbsp;新規登録
		</button>
	</span>
</div>

<% if false %>
<div id="event_result"><br/></div>

<div id="category_trees"></div>
<% end %>

<div class="modal fade" id="modalNew" tabindex="-1" aria-labelledby="modalNew" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
			<%
				@content_category                 = ContentCategory.new
				@content_category.shop            = @shop
				@content_category.parent          = @parent_category
				@content_category.web_page        = @parent_category.web_page 
				@content_category.category_type   = ContentCategory::TYPE_CATEGORY
			%>
			<%= form_for @content_category, url: admin_content_news_content_category_create_path, method: :post do |f| %>
			<%= hidden_field 'content_category', 'shop_id' %>
			<%= hidden_field 'content_category', 'parent_id' %>
			<%= hidden_field 'content_category', 'web_page_id' %>
			<%= hidden_field 'content_category', 'category_type' %>
                <div class="modal-header">
                    <h5 class="modal-title">新規カテゴリー登録</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
					<div class="mb-3 row">
						<label for="name" class="col-sm-4 col-form-label">カテゴリー</label>
						<div class="col-sm-8">
							<%= f.text_field :title,  {class: "form-control", placeholder: "カテゴリー名称を入力", :required => true, autofocus: true}  %>
						</div>
					</div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success"><%= new_icon('登録') %>&nbsp;登録</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                </div>
			<% end %>
        </div>
    </div>
</div>

<!-- Modal -->

<% unless @current_category.children.blank? %>
	<h4>サブ・カテゴリー</h4>
	<% array = @current_category.children.in_groups_of(3, false)%>
	<div class="row">
		<% for i in 0..(array.size-1) %>
			<% @lines = array[i] %>
		        <div class="col-sm-4">
		        	<%= render :partial=>"item_category_tree", :locals => {:temp_local => @lines[0]}  if @lines.size>=1 %>
				</div>		
		        <div class="col-sm-4">
		        	<%= render :partial=>"item_category_tree", :locals => {:temp_local => @lines[1]}  if @lines.size>=2 %>
				</div>		
		        <div class="col-sm-4">
		        	<%= render :partial=>"item_category_tree", :locals => {:temp_local => @lines[2]}  if @lines.size>=3 %>
				</div>
		<% end %>
	</div>
<% end %>



<script type="text/javascript">
//<![CDATA[
function demo_rename() {
	var ref = $('#category_trees').jstree(true),
		sel = ref.get_selected();
	if(!sel.length) { return false; }
	sel = sel[0];
	ref.edit(sel);
};
function demo_delete() {
	var ref = $('#category_trees').jstree(true),
		sel = ref.get_selected();
	if(!sel.length) { return false; }
	ref.delete_node(sel);
};

$('#category_trees')  // listen for event
  .on('changed.jstree', function (e, data) {
    var i, j, r = [];
    for(i = 0, j = data.selected.length; i < j; i++) {
      r.push(data.instance.get_node(data.selected[i]).text);
    }
//    $('#event_result').html('Selected: ' + r.join(', '));
  })
  .on('move_node.jstree', function (e, data) {
//    $('#event_result').html('MoveNode: ' + 'node='+data.node.id + '/ parent='+data.parent + '/ position='+data.position);
	<% update_url = url_for(:action=>'move_cat') %>
    $.get("<%=update_url%>", { id: data.node.id, parent: data.parent, position: data.position } );
  })
  .on('rename_node.jstree', function (e, data) {
//    $('#event_result').html('RenameNode: ' + 'node='+data.node.id + '/ parent='+data.parent + '/ position='+data.position);
	<% rename_url = url_for(:action=>'rename_cat') %>
    $.get("<%=rename_url%>", { id: data.node.id, text: data.text } );
  })
  .on('delete_node.jstree', function (e, data) {
//    $('#event_result').html('RenameNode: ' + 'node='+data.node.id + '/ parent='+data.parent + '/ position='+data.position);
	<% delete_url = url_for(:action=>'delete_cat') %>
    $.get("<%=delete_url%>", { id: data.node.id } );
  })
  // create the instance
  .jstree({
  "core" : {
    "animation" : 0,
    "check_callback" : true,
	"multiple" : false,
    "themes" : { "stripes" : true },
    'data' : {
		<% url = url_for(:controller=>'bs_abs_content_bag', :action=>'json_cat', :parent=>@parent_category.id) %>
		'url' : "<%= url %>",
		'data' : function (node) {
			return { 'id' : node.id };
		},
    }
  },
  "plugins" : [
    "dnd",
    "state", "wholerow"
  ]
});
//]]>
</script>
